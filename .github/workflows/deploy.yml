name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
          npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment package
        run: |
          # Remove unnecessary files
          rm -rf node_modules .git .github .gitignore .env.example
          rm -f package.json package-lock.json vite.config.js phpunit.xml
          tar -czf deploy.tar.gz .

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          script: |
            set -e
            
            APP_PATH="${{ secrets.SERVER_PATH }}"
            
            echo "=== Deploying to ${APP_PATH} ==="
            
            # Create app directory if doesn't exist
            mkdir -p "${APP_PATH}"
            
            # Backup storage and .env
            TEMP_STORAGE="/tmp/storage_backup_$$"
            TEMP_ENV="/tmp/.env_backup_$$"
            
            if [ -d "${APP_PATH}/storage" ]; then
              cp -r "${APP_PATH}/storage" "${TEMP_STORAGE}"
            fi
            
            if [ -f "${APP_PATH}/.env" ]; then
              cp "${APP_PATH}/.env" "${TEMP_ENV}"
            fi
            
            # Extract new deployment
            cd "${APP_PATH}"
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz
            
            # Restore storage
            if [ -d "${TEMP_STORAGE}" ]; then
              rm -rf storage
              mv "${TEMP_STORAGE}" storage
            else
              # First deployment - create storage structure
              mkdir -p storage/app/public
              mkdir -p storage/framework/{cache,sessions,views}
              mkdir -p storage/logs
              mkdir -p storage/{blog,products,categories,articles,editor}
              chmod -R 775 storage
            fi
            
            # Restore or create .env
            if [ -f "${TEMP_ENV}" ]; then
              mv "${TEMP_ENV}" .env
            else
              # First deployment - create .env
              cp .env.example .env
              php artisan key:generate
              echo "⚠️ Please update .env with your database and app settings!"
            fi
            
            # Run Laravel commands
            php artisan migrate --force
            php artisan storage:link
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "=== Deployment Complete ==="
