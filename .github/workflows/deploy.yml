name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
          npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment package
        run: |
          # Remove unnecessary files
          # rm -rf node_modules .git .github .gitignore .env.example
          # rm -f package.json package-lock.json vite.config.js phpunit.xml
          # tar -czf deploy.tar.gz .

          # Create a clean build directory
          mkdir build

          # Copy only required files
          rsync -av --exclude=node_modules --exclude=.git --exclude=.github \
            --exclude=.gitignore \
            --exclude=package.json --exclude=package-lock.json \
            --exclude=vite.config.js --exclude=phpunit.xml \
            ./ build/

          # Create the tar from the clean folder
          tar -czf deploy.tar.gz -C build .

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.1.0
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          envs: DB_HOST,DB_PORT,DB_DATABASE,DB_USERNAME,DB_PASSWORD
          script: |
            set -e
            
            APP_PATH="/home/web/sites/laffaro.com/html"
            
            echo "=== Starting Deployment ==="
            echo "Deploying to: ${APP_PATH}"
            
            # Create app directory if doesn't exist
            mkdir -p "${APP_PATH}"
            
            # Backup storage and .env
            TEMP_STORAGE="/tmp/storage_backup_$$"
            TEMP_ENV="/tmp/.env_backup_$$"
            
            if [ -d "${APP_PATH}/storage" ]; then
              cp -r "${APP_PATH}/storage" "${TEMP_STORAGE}"
            fi
            
            if [ -f "${APP_PATH}/.env" ]; then
              cp "${APP_PATH}/.env" "${TEMP_ENV}"
            fi
            
            # Extract new deployment
            cd "${APP_PATH}"
            sudo tar -xzf /tmp/deploy.tar.gz
            sudo rm /tmp/deploy.tar.gz
            
            # Restore storage
            if [ -d "${TEMP_STORAGE}" ]; then
              sudo rm -rf storage
              sudo mv "${TEMP_STORAGE}" storage
            else
              # First deployment - create storage structure
              mkdir -p storage/app/public
              mkdir -p storage/framework/{cache,sessions,views}
              mkdir -p storage/logs
              mkdir -p storage/app/public/{blog,products,categories,articles,editor}
              chmod -R 775 storage
            fi
            
            # Restore or create .env
            if [ -f "${TEMP_ENV}" ]; then
              sudo mv "${TEMP_ENV}" .env
            else
              # First deployment - create .env
              sudo cp .env.example .env
              sudo php artisan key:generate
            fi
            
            # Update database credentials from GitHub secrets
            sudo sed -i "s|^DB_HOST=.*|DB_HOST=${DB_HOST}|" .env
            sudo sed -i "s|^DB_PORT=.*|DB_PORT=${DB_PORT}|" .env
            sudo sed -i "s|^DB_DATABASE=.*|DB_DATABASE=${DB_DATABASE}|" .env
            sudo sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${DB_USERNAME}|" .env
            sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${DB_PASSWORD}|" .env
            
            echo "✅ Database credentials updated from GitHub secrets"

            # Fix storage permissions
            echo "Setting storage permissions..."
            sudo chmod -R 775 storage
            sudo sudo chmod -R 775 bootstrap/cache
            
            # Ensure storage directories are web-accessible
            sudo find storage -type f -exec chmod 664 {} \;
            sudo find storage -type d -exec chmod 775 {} \;
            
            # Remove old storage link if exists
            rm -f public/storage
            
            # Run Laravel commands
            php artisan migrate --force
            php artisan storage:link --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Verify storage link
            if [ -L "public/storage" ]; then
              echo "✅ Storage link created successfully"
              ls -la public/storage
            else
              echo "⚠️ Storage link creation failed"
            fi
            
          
            
            echo "=== Deployment Complete ==="
